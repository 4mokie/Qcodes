

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating QCoDeS instrument drivers &mdash; QCoDeS 0.1.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="QCoDeS 0.1.3 documentation" href="../index.html"/>
        <link rel="up" title="Examples of using QCoDeS" href="../examples/index.html"/>
        <link rel="next" title="Datasaving Examples" href="Datasaving examples.html"/>
        <link rel="prev" title="QCoDeS config" href="Configuring_QCoDeS.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> QCoDeS
          

          
          </a>

          
            
            
              <div class="version">
                0.1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../start/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help.html">Get Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/generated/qcodes.instrument_drivers.html">qcodes.instrument_drivers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Qcodes project plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changelogs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples/index.html">Examples of using QCoDeS</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../examples/index.html#basic-examples">Basic examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Combined Parameters.html">Combined Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="Configuring_QCoDeS.html">QCoDeS config</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Creating QCoDeS instrument drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#base-classes">Base Classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visainstrument-simple-example">VisaInstrument: Simple example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visainstrument-a-more-involved-example">VisaInstrument: a more involved example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dll-based-instruments">DLL-based instruments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manual-instruments">Manual instruments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-parameter-classes">Custom Parameter classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dynamically-adding-and-removing-parameters">Dynamically adding and removing parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions">Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#organization">Organization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Datasaving examples.html">Datasaving Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="Measure without a Loop.html">Measure without a Loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="Metadata.html">Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="Metadata with instruments.html">Metadata with instruments</a></li>
<li class="toctree-l3"><a class="reference internal" href="Parameters.html">Parameters in QCoDeS</a></li>
<li class="toctree-l3"><a class="reference internal" href="Qcodes location-format example.html">Qcodes location-format example</a></li>
<li class="toctree-l3"><a class="reference internal" href="Tutorial.html">QCoDeS tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html#drivers">Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html#benchmarking">Benchmarking</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">QCoDeS</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples/index.html">Examples of using QCoDeS</a> &raquo;</li>
        
      <li>Creating QCoDeS instrument drivers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/_notebooks/Creating Instrument Drivers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-qcodes-instrument-drivers">
<h1>Creating QCoDeS instrument drivers<a class="headerlink" href="#creating-qcodes-instrument-drivers" title="Permalink to this headline">¶</a></h1>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="c1"># most of the drivers only need a couple of these... moved all up here for clarity below</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ctypes</span>  <span class="c1"># only for DLL-based instrument</span>

<span class="kn">import</span> <span class="nn">qcodes</span> <span class="k">as</span> <span class="nn">qc</span>
<span class="kn">from</span> <span class="nn">qcodes</span> <span class="k">import</span> <span class="p">(</span><span class="n">Instrument</span><span class="p">,</span> <span class="n">VisaInstrument</span><span class="p">,</span>
                    <span class="n">ManualParameter</span><span class="p">,</span> <span class="n">MultiParameter</span><span class="p">,</span>
                    <span class="n">validators</span> <span class="k">as</span> <span class="n">vals</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="base-classes">
<h2>Base Classes<a class="headerlink" href="#base-classes" title="Permalink to this headline">¶</a></h2>
<p>There are 3 available: - <code class="docutils literal"><span class="pre">VisaInstrument</span></code> - for most instruments that
communicate over a text channel (ethernet, GPIB, serial, USB...) that do
not have a custom DLL or other driver to manage low-level commands. -
<code class="docutils literal"><span class="pre">IPInstrument</span></code> - a specialized driver just for ethernet connections.
Otherwise works nearly identically to <code class="docutils literal"><span class="pre">VisaInstrument</span></code>. -
<code class="docutils literal"><span class="pre">Instrument</span></code> - superclass of both <code class="docutils literal"><span class="pre">VisaInstrument</span></code> and
<code class="docutils literal"><span class="pre">IPInstrument</span></code>, use this if you do not communicate over a text
channel, for example: - PCI cards with their own DLLs - Instruments with
only manual controls.</p>
</div>
<div class="section" id="visainstrument-simple-example">
<h2>VisaInstrument: Simple example<a class="headerlink" href="#visainstrument-simple-example" title="Permalink to this headline">¶</a></h2>
<p>The Weinschel 8320 driver is about as basic a driver as you can get. It
only defines one parameter, &#8220;attenuation&#8221;. All the comments here are my
additions to describe what&#8217;s happening.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Weinschel_8320</span><span class="p">(</span><span class="n">VisaInstrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    QCoDeS driver for the stepped attenuator</span>
<span class="sd">    Weinschel is formerly known as Aeroflex/Weinschel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># all instrument constructors should accept **kwargs and pass them on to</span>
    <span class="c1"># super().__init__. This is important for the deprecated multiprocessing</span>
    <span class="c1"># architecture, so may change in the near future.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># supplying the terminator means you don&#39;t need to remove it from every response</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">terminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;attenuation&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;dB&#39;</span><span class="p">,</span>
                           <span class="c1"># the value you set will be inserted in this command with</span>
                           <span class="c1"># regular python string substitution. The instrument wants</span>
                           <span class="c1"># an integer zero-padded to 2 digits. For robustness, don&#39;t</span>
                           <span class="c1"># assume you&#39;ll get an integer input though - try to allow</span>
                           <span class="c1"># floats (as opposed to {:0=2d})</span>
                           <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;ATTN ALL </span><span class="si">{:02.0f}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;ATTN? 1&#39;</span><span class="p">,</span>
                           <span class="c1"># setting any attenuation other than 0, 2, ... 60 will error.</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">60.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
                           <span class="c1"># the return value of get() is a string, but we want to</span>
                           <span class="c1"># turn it into a (float) number</span>
                           <span class="n">get_parser</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># it&#39;s a good idea to call connect_message at the end of your constructor.</span>
        <span class="c1"># this calls the &#39;IDN&#39; parameter that the base Instrument class creates for</span>
        <span class="c1"># every instrument (you can override the `get_idn` method if it doesn&#39;t work</span>
        <span class="c1"># in the standard VISA form for your instrument) which serves two purposes:</span>
        <span class="c1"># 1) verifies that you are connected to the instrument</span>
        <span class="c1"># 2) gets the ID info so it will be included with metadata snapshots later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_message</span><span class="p">()</span>

<span class="c1"># instantiating and using this instrument (commented out because I can&#39;t actually do it!)</span>
<span class="c1">#</span>
<span class="c1"># from qcodes.instrument_drivers.weinschel.Weinschel_8320 import Weinschel_8320</span>
<span class="c1"># weinschel = Weinschel_8320(&#39;w8320_1&#39;, &#39;TCPIP0::172.20.2.212::inst0::INSTR&#39;)</span>
<span class="c1"># weinschel.attenuation(40)</span>
</pre></div>
</div>
</div>
<div class="section" id="visainstrument-a-more-involved-example">
<h2>VisaInstrument: a more involved example<a class="headerlink" href="#visainstrument-a-more-involved-example" title="Permalink to this headline">¶</a></h2>
<p>the K2600 breaks one physical instrument into two software instruments,
one for each channel. It: - has a custom IDN parser - transforms the ask
and write commands to simplify them and insert the channel. -
demonstrates <code class="docutils literal"><span class="pre">val_mapping</span></code> for bidirectional encoding of enumerated
parameters</p>
<p>I&#8217;ve removed some parameters for brevity.</p>
<p>Note the nice docstring that describes the status of the code!</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Keithley_2600</span><span class="p">(</span><span class="n">VisaInstrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    channel: use channel &#39;a&#39; or &#39;b&#39;</span>

<span class="sd">    This is the qcodes driver for the Keithley_2600 Source-Meter series,</span>
<span class="sd">    tested with Keithley_2614B</span>

<span class="sd">    Status: beta-version.</span>
<span class="sd">        TODO:</span>
<span class="sd">        - Add all parameters that are in the manual</span>
<span class="sd">        - range and limit should be set according to mode</span>
<span class="sd">        - add ramping and such stuff</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">terminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;volt&#39;</span><span class="p">,</span> <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;measure.v()&#39;</span><span class="p">,</span>
                           <span class="n">get_parser</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;source.levelv=</span><span class="si">{:.8f}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Voltage&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;curr&#39;</span><span class="p">,</span> <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;measure.i()&#39;</span><span class="p">,</span>
                           <span class="n">get_parser</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;source.leveli=</span><span class="si">{:.8f}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Current&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span>
                           <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;source.func&#39;</span><span class="p">,</span>
                           <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;source.func=</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="c1"># the K2600 interprets &#39;0&#39; as current and &#39;1&#39; as voltage</span>
                           <span class="c1"># but we want to type: k2600a.mode(&#39;current&#39;), not .mode(0)</span>
                           <span class="c1"># val_mapping describes, all in one dictionary:</span>
                           <span class="c1"># - the valid set values (&#39;current&#39; and &#39;voltage&#39;)</span>
                           <span class="c1"># - the encoding to instrument codes (current-&gt;0, voltage-&gt;1)</span>
                           <span class="c1"># - the decoding back to parameter values (0-&gt;current, 1-&gt;voltage)</span>
                           <span class="c1"># `ask` returns a string, but because integer encodings are so</span>
                           <span class="c1"># common we automatically check if the string is an integer</span>
                           <span class="c1"># when you use val_mapping</span>
                           <span class="n">val_mapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;voltage&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                           <span class="n">get_cmd</span><span class="o">=</span><span class="s1">&#39;source.output&#39;</span><span class="p">,</span>
                           <span class="n">set_cmd</span><span class="o">=</span><span class="s1">&#39;source.output=</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="c1"># output on/off has another val_mapping</span>
                           <span class="n">val_mapping</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;on&#39;</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect_message</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_idn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IDN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_raw</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">)</span>
        <span class="n">vendor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">firmware</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">IDN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>

        <span class="n">IDN</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vendor&#39;</span><span class="p">:</span> <span class="n">vendor</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
               <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">serial</span><span class="p">,</span> <span class="s1">&#39;firmware&#39;</span><span class="p">:</span> <span class="n">firmware</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">IDN</span>

    <span class="c1"># Reset method. Since this is a simple command to write, this could also have been:</span>
    <span class="c1"># self.add_function(&#39;reset&#39;, call_cmd=&#39;reset()&#39;)</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;reset()&#39;</span><span class="p">)</span>

    <span class="c1"># transformation of ask and write commands. From the Instrument.ask docstring:</span>
    <span class="c1"># Subclasses that transform ``cmd`` should override ``ask``, and in</span>
    <span class="c1"># it call ``super().ask(new_cmd)``. Subclasses that define a new</span>
    <span class="c1"># hardware communication should instead override ``ask_raw``.</span>
    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s1">&#39;print(smu</span><span class="si">{:s}</span><span class="s1">.</span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;smu</span><span class="si">{:s}</span><span class="s1">.</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="dll-based-instruments">
<h2>DLL-based instruments<a class="headerlink" href="#dll-based-instruments" title="Permalink to this headline">¶</a></h2>
<p>The Alazar cards use their own DLL. C interfaces tend to need a lot of
boilerplate, so I&#8217;m not going to include it all. The key is: use
<code class="docutils literal"><span class="pre">Instrument</span></code> directly, load the DLL, and have parameters interact with
it.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AlazarTech_ATS</span><span class="p">(</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="n">dll_path</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">WINDOWS</span><span class="se">\\</span><span class="s1">System32</span><span class="se">\\</span><span class="s1">ATSApi&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">system_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">board_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dll_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># connect to the DLL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ATS_dll</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">dll_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dll_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ATS_dll</span><span class="o">.</span><span class="n">AlazarGetBoardBySystemID</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span>
                                                              <span class="n">board_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;AlazarTech_ATS not found at &#39;</span>
                            <span class="s1">&#39;system </span><span class="si">{}</span><span class="s1">, board </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="n">board_id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># the Alazar driver includes its own parameter class to hold values</span>
        <span class="c1"># until later config is called, and warn if you try to read a value</span>
        <span class="c1"># that hasn&#39;t been sent to config.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;clock_source&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">AlazarParameter</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clock Source&#39;</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">=</span><span class="s1">&#39;INTERNAL_CLOCK&#39;</span><span class="p">,</span>
                           <span class="n">byte_to_value_dict</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;INTERNAL_CLOCK&#39;</span><span class="p">,</span>
                                               <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;SLOW_EXTERNAL_CLOCK&#39;</span><span class="p">,</span>
                                               <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;EXTERNAL_CLOCK_AC&#39;</span><span class="p">,</span>
                                               <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;EXTERNAL_CLOCK_10_MHz_REF&#39;</span><span class="p">})</span>

        <span class="c1"># etc...</span>
</pre></div>
</div>
</div>
<div class="section" id="manual-instruments">
<h2>Manual instruments<a class="headerlink" href="#manual-instruments" title="Permalink to this headline">¶</a></h2>
<p>A totally manual instrument (like the ithaco 1211) will contain only
<code class="docutils literal"><span class="pre">ManualParameter``s.</span> <span class="pre">Some</span> <span class="pre">instruments</span> <span class="pre">may</span> <span class="pre">have</span> <span class="pre">a</span> <span class="pre">mix</span> <span class="pre">of</span> <span class="pre">manual</span> <span class="pre">and</span>
<span class="pre">standard</span> <span class="pre">parameters.</span> <span class="pre">Here</span> <span class="pre">we</span> <span class="pre">also</span> <span class="pre">define</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">``CurrentParameter</span></code>
class that uses the ithaco parameters to convert a measured voltage to a
current.</p>
<div class="code ipython3 highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CurrentParameter</span><span class="p">(</span><span class="n">MultiParameter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Current measurement via an Ithaco preamp and a measured voltage.</span>

<span class="sd">    To be used when you feed a current into the Ithaco, send the Ithaco&#39;s</span>
<span class="sd">    output voltage to a lockin or other voltage amplifier, and you have</span>
<span class="sd">    the voltage reading from that amplifier as a qcodes parameter.</span>

<span class="sd">    ``CurrentParameter.get()`` returns ``(voltage_raw, current)``</span>

<span class="sd">    Args:</span>
<span class="sd">        measured_param (Parameter): a gettable parameter returning the</span>
<span class="sd">            voltage read from the Ithaco output.</span>

<span class="sd">        c_amp_ins (Ithaco_1211): an Ithaco instance where you manually</span>
<span class="sd">            maintain the present settings of the real Ithaco amp.</span>

<span class="sd">        name (str): the name of the current output. Default &#39;curr&#39;.</span>
<span class="sd">            Also used as the name of the whole parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measured_param</span><span class="p">,</span> <span class="n">c_amp_ins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;curr&#39;</span><span class="p">):</span>
        <span class="n">p_name</span> <span class="o">=</span> <span class="n">measured_param</span><span class="o">.</span><span class="n">name</span>

        <span class="n">p_label</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">measured_param</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p_unit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">measured_param</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="n">p_name</span><span class="o">+</span><span class="s1">&#39;_raw&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                         <span class="n">shapes</span><span class="o">=</span><span class="p">((),</span> <span class="p">()),</span>
                         <span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="n">p_label</span><span class="p">,</span> <span class="s1">&#39;Current&#39;</span><span class="p">),</span>
                         <span class="n">units</span><span class="o">=</span><span class="p">(</span><span class="n">p_unit</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_measured_param</span> <span class="o">=</span> <span class="n">measured_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span> <span class="o">=</span> <span class="n">c_amp_ins</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">volt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measured_param</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="o">.</span><span class="n">sens</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="o">.</span><span class="n">sens_factor</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">*</span> <span class="n">volt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="o">.</span><span class="n">invert</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="n">current</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">volt</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_val</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Ithaco_1211</span><span class="p">(</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the qcodes driver for the Ithaco 1211 Current-preamplifier.</span>

<span class="sd">    This is a virtual driver only and will not talk to your instrument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ManualParameter has an &quot;initial_value&quot; kwarg, but if you use this</span>
        <span class="c1"># you must be careful to check that it&#39;s correct before relying on it.</span>
        <span class="c1"># if you don&#39;t set initial_value, it will start out as None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;sens&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">ManualParameter</span><span class="p">,</span>
                           <span class="n">initial_value</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sensitivity&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="s1">&#39;A/V&#39;</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mf">1e-11</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1e-09</span><span class="p">,</span> <span class="mf">1e-08</span><span class="p">,</span> <span class="mf">1e-07</span><span class="p">,</span>
                                          <span class="mf">1e-06</span><span class="p">,</span> <span class="mf">1e-05</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;invert&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">ManualParameter</span><span class="p">,</span>
                           <span class="n">initial_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Inverted output&#39;</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Bool</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;sens_factor&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">ManualParameter</span><span class="p">,</span>
                           <span class="n">initial_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sensitivity factor&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;suppression&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">ManualParameter</span><span class="p">,</span>
                           <span class="n">initial_value</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Suppression&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1e-09</span><span class="p">,</span> <span class="mf">1e-08</span><span class="p">,</span> <span class="mf">1e-07</span><span class="p">,</span> <span class="mf">1e-06</span><span class="p">,</span>
                                          <span class="mf">1e-05</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s1">&#39;risetime&#39;</span><span class="p">,</span>
                           <span class="n">parameter_class</span><span class="o">=</span><span class="n">ManualParameter</span><span class="p">,</span>
                           <span class="n">initial_value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rise Time&#39;</span><span class="p">,</span>
                           <span class="n">units</span><span class="o">=</span><span class="s1">&#39;msec&#39;</span><span class="p">,</span>
                           <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
                                          <span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_idn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;vendor&#39;</span><span class="p">:</span> <span class="s1">&#39;Ithaco (DL Instruments)&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;1211&#39;</span><span class="p">,</span>
                <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;firmware&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-parameter-classes">
<h2>Custom Parameter classes<a class="headerlink" href="#custom-parameter-classes" title="Permalink to this headline">¶</a></h2>
<p>When you call: <code class="docutils literal"><span class="pre">self.add_parameter(name,</span> <span class="pre">**kwargs)</span></code> you create a
<code class="docutils literal"><span class="pre">StandardParameter</span></code>. But with the <code class="docutils literal"><span class="pre">parameter_class</span></code> kwarg you can
invoke any class you want:
<code class="docutils literal"><span class="pre">self.add_parameter(name,</span> <span class="pre">parameter_class=OtherClass,</span> <span class="pre">**kwargs)</span></code></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">StandardParameter</span></code> handles most common instrument settings and
measurements.</li>
<li>Accepts get and/or set commands as either strings for the
instrument&#8217;s <code class="docutils literal"><span class="pre">ask</span></code> and <code class="docutils literal"><span class="pre">write</span></code> methods, or functions/methods.</li>
<li>Has options for translating between instrument codes and more
meaningful data values</li>
<li>Supports software-controlled ramping</li>
<li><code class="docutils literal"><span class="pre">ManualParameter</span></code> is for things you don&#8217;t control electronically,
like physical knobs. When you <em>manually</em> change the knob, you must
<em>manually</em> change it in software too.</li>
<li>Any other parameter class may be used in <code class="docutils literal"><span class="pre">add_parameter</span></code>, if it
accepts <code class="docutils literal"><span class="pre">name</span></code> and <code class="docutils literal"><span class="pre">instrument</span></code> as constructor kwargs. Generally
these should subclass <code class="docutils literal"><span class="pre">Parameter</span></code>, <code class="docutils literal"><span class="pre">ArrayParameter</span></code>, or
<code class="docutils literal"><span class="pre">MultiParameter</span></code>.</li>
</ul>
</div>
<div class="section" id="dynamically-adding-and-removing-parameters">
<h2>Dynamically adding and removing parameters<a class="headerlink" href="#dynamically-adding-and-removing-parameters" title="Permalink to this headline">¶</a></h2>
<p>Sometimes when conditions change (for example, the mode of operation of
the instrument is changed from current to voltage measurement) you want
different parameters to be available.</p>
<p>To delete existing parameters: <code class="docutils literal"><span class="pre">del</span> <span class="pre">self.parameters[name_to_delete]</span></code>
And to add more, do the same thing as you did initially:
<code class="docutils literal"><span class="pre">self.add_parameter(new_name,</span> <span class="pre">**kwargs)</span></code></p>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<p>a <code class="docutils literal"><span class="pre">Function</span></code> is some action that the instrument can do, but doesn&#8217;t
correspond to a particular state variable or acquired data. For example,
reset, trigger, or beep. Complex cases are best handled by adding your
own methods to the instrument, but simple cases (particularly simple
commands like <code class="docutils literal"><span class="pre">*RST</span></code>) can use <code class="docutils literal"><span class="pre">add_function</span></code>, which acts like a
simplified <code class="docutils literal"><span class="pre">add_parameter</span></code>.</p>
</div>
<div class="section" id="organization">
<h2>Organization<a class="headerlink" href="#organization" title="Permalink to this headline">¶</a></h2>
<p>Your drivers do not need to be part of QCoDeS in order to use them with
QCoDeS, but we strongly encourage you to contribute them to the project.
That way we prevent duplication of effort, and you will likely get help
making the driver better, with more features and better code.</p>
<p>Make one driver per module, inside a directory named for the company (or
institution), within the <code class="docutils literal"><span class="pre">instrument_drivers</span></code> directory, following the
convention:</p>
<p><code class="docutils literal"><span class="pre">instrument_drivers.&lt;company&gt;.&lt;model&gt;.&lt;company&gt;_&lt;model&gt;</span></code> - example:
<code class="docutils literal"><span class="pre">instrument_drivers.AlazarTech.ATS9870.AlazarTech_ATS9870</span></code></p>
<p>Although the class name can be just the model if it is globally
unambiguous. For example: - example:
<code class="docutils literal"><span class="pre">instrument_drivers.stanford_research.SR560.SR560</span></code></p>
<p>And note that due to mergers, some drivers may not be in the folder you
expect: - example:
<code class="docutils literal"><span class="pre">instrument_drivers.tektronix.Keithley_2600.Keithley_2600</span></code></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Datasaving examples.html" class="btn btn-neutral float-right" title="Datasaving Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Configuring_QCoDeS.html" class="btn btn-neutral" title="QCoDeS config" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>