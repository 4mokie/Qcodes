

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qcodes.process.server &mdash; QCoDeS 0.1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="QCoDeS 0.1.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> QCoDeS
          

          
          </a>

          
            
            
              <div class="version">
                0.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../start/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../help.html">Get Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/index.html">Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto/qcodes.instrument_drivers.html">qcodes.instrument_drivers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Qcodes project plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes/index.html">Changelogs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">QCoDeS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>qcodes.process.server</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qcodes.process.server</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Common Server process and ServerManager architecture.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">format_exc</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">QUERY_WRITE</span> <span class="o">=</span> <span class="s1">&#39;WRITE&#39;</span>
<span class="n">QUERY_ASK</span> <span class="o">=</span> <span class="s1">&#39;ASK&#39;</span>
<span class="n">RESPONSE_OK</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
<span class="n">RESPONSE_ERROR</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span>

<span class="kn">from</span> <span class="nn">qcodes.utils.nested_attrs</span> <span class="kn">import</span> <span class="n">NestedAttrAccess</span>
<span class="kn">from</span> <span class="nn">.qcodes_process</span> <span class="kn">import</span> <span class="n">QcodesProcess</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">kill_queue</span>


<div class="viewcode-block" id="ServerManager"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager">[docs]</a><span class="k">class</span> <span class="nc">ServerManager</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and communicates with a separate server process.</span>

<span class="sd">    Starts a `QcodesProcess`, and on that process it constructs a server</span>
<span class="sd">    object of type `server_class`, which should normally be a subclass of</span>
<span class="sd">    `BaseServer`. Client processes query the server via:</span>
<span class="sd">    `manager.ask(func_name, *args, **kwargs)`: if they want a response or want</span>
<span class="sd">        to wait for confirmation that the query has completed</span>
<span class="sd">    `manager.write(func_name, *args, **kwargs)`: if they want to continue</span>
<span class="sd">        immediately without blocking for the query.</span>
<span class="sd">    The server communicates with this manager via two multiprocessing `Queue`s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server_class</span><span class="p">,</span> <span class="n">shared_attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">query_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the ServerManager and start its server.</span>

<span class="sd">        name: the name of the server. Can include .format specs to insert</span>
<span class="sd">            all or part of the uuid</span>
<span class="sd">        server_class: the class to create within the new process.</span>
<span class="sd">            the constructor will be passed arguments:</span>
<span class="sd">                query_queue, response_queue, shared_attrs</span>
<span class="sd">            and should start an infinite loop watching query_queue and posting</span>
<span class="sd">            responses to response_queue.</span>
<span class="sd">        shared_attrs: any objects that need to be passed to the server on</span>
<span class="sd">            startup, generally objects like Queues that are picklable only for</span>
<span class="sd">            inheritance by a new process.</span>
<span class="sd">        query_timeout: (default None) the default max time to wait for</span>
<span class="sd">            responses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_class</span> <span class="o">=</span> <span class="n">server_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shared_attrs</span> <span class="o">=</span> <span class="n">shared_attrs</span>

        <span class="c1"># query_lock is only used with queries that get responses</span>
        <span class="c1"># to make sure the process that asked the question is the one</span>
        <span class="c1"># that gets the response.</span>
        <span class="c1"># Any query that does NOT expect a response can just dump it in</span>
        <span class="c1"># and move on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_lock</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

        <span class="c1"># uuid is used to pass references to this object around</span>
        <span class="c1"># for example, to get it after someone else has sent it to a server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query_timeout</span> <span class="o">=</span> <span class="n">query_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_server</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_start_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">QcodesProcess</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_server</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_shared_attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;restarted {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># can&#39;t test is_alive from outside the main process</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="ServerManager.write"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a query to the server that does not expect a response.</span>

<span class="sd">        `write(func_name, *args, **kwargs)` proxies to server method:</span>
<span class="sd">        `server.handle_&lt;func_name&gt;(*args, **kwargs)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_alive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">QUERY_WRITE</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="ServerManager.ask"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager.ask">[docs]</a>    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a query to the server and wait for a response.</span>

<span class="sd">        `resp = ask(func_name, *args, **kwargs)` proxies to server method:</span>
<span class="sd">        `resp = server.handle_&lt;func_name&gt;(*args, **kwargs)`</span>

<span class="sd">        optional timeout (default None) - not recommended, as if we quit</span>
<span class="sd">        before reading the response, the query queue can get out of sync</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_alive</span><span class="p">()</span>

        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect_error</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">QUERY_ASK</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_lock</span><span class="p">:</span>
            <span class="c1"># in case a previous query errored and left something on the</span>
            <span class="c1"># response queue, clear it</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;unexpected data in response queue before ask:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">logging</span> <span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;unexpected multiple responses in queue during ask, &#39;</span>
                    <span class="s1">&#39;using the last one. earlier item(s):</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&lt;MALFORMED&gt;&#39;</span><span class="p">,</span> <span class="n">res</span>

        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">RESPONSE_OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_error</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">error_str</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">error_head</span> <span class="o">=</span> <span class="s1">&#39;*** error on {} ***&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">error_head</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">while executing query: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">RESPONSE_ERROR</span><span class="p">:</span>
            <span class="n">error_head</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">unrecognized response code: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># try to match the error type, if it&#39;s a built-in type</span>
        <span class="n">error_type_line</span> <span class="o">=</span> <span class="n">error_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">error_type_str</span> <span class="o">=</span> <span class="n">error_type_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">err_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">error_type_str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err_type</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">err_type</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="n">err_type</span> <span class="o">=</span> <span class="ne">RuntimeError</span>

        <span class="k">raise</span> <span class="n">err_type</span><span class="p">(</span><span class="n">error_head</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">error_str</span><span class="p">)</span>

<div class="viewcode-block" id="ServerManager.halt"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager.halt">[docs]</a>    <span class="k">def</span> <span class="nf">halt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Halt the server and end its process.</span>

<span class="sd">        Does not tear down, after this the server can still be started again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;halt&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;ServerManager did not respond to halt &#39;</span>
                                <span class="s1">&#39;signal, terminated&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="c1"># happens when we get here from other than the main process</span>
            <span class="c1"># where we shouldn&#39;t be able to kill the server anyway</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="ServerManager.restart"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the server.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerManager.close"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.ServerManager.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Irreversibly stop the server and manager.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halt</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">]:</span>
            <span class="n">qname</span> <span class="o">=</span> <span class="s1">&#39;_{}_queue&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">):</span>
                <span class="n">kill_queue</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qname</span><span class="p">))</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">qname</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;query_lock&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_lock</span></div></div>


<div class="viewcode-block" id="BaseServer"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer">[docs]</a><span class="k">class</span> <span class="nc">BaseServer</span><span class="p">(</span><span class="n">NestedAttrAccess</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for servers to run in separate processes.</span>

<span class="sd">    The server is started inside a `QcodesProcess` by a `ServerManager`,</span>
<span class="sd">    and unifies the query handling protocol so that we are robust against</span>
<span class="sd">    deadlocks, out of sync queues, or hidden errors.</span>

<span class="sd">    This base class doesn&#39;t start the event loop, a subclass should</span>
<span class="sd">    either call `self.run_event_loop()` at the end of its `__init__` or</span>
<span class="sd">    provide its own event loop. If making your own event loop, be sure to</span>
<span class="sd">    call `self.process_query(query)` on any item that arrives in</span>
<span class="sd">    `self._query_queue`.</span>

<span class="sd">    Subclasses should define handlers `handle_&lt;func_name&gt;`, such that calls:</span>
<span class="sd">        `response = server_manager.ask(func_name, *args, **kwargs)`</span>
<span class="sd">        `server_manager.write(func_name, *args, **kwargs)`</span>
<span class="sd">    map onto method calls:</span>
<span class="sd">        `response = self.handle_&lt;func_name&gt;(*args, **kwargs)`</span>

<span class="sd">    The actual query passed through the queue and unpacked by `process_query`</span>
<span class="sd">    has the form `(code, func_name[, args][, kwargs])` where `code` is:</span>

<span class="sd">    - `QUERY_ASK` (from `server_manager.ask`): will always send a response,</span>
<span class="sd">      even if the function returns nothing (None) or throws an error.</span>

<span class="sd">    - `QUERY_WRITE` (from `server_manager.write`): will NEVER send a response,</span>
<span class="sd">      return values are ignored and errors go to the logging framework.</span>

<span class="sd">    Three handlers are predefined:</span>

<span class="sd">    - `handle_halt` (but override it if your event loop does not use</span>
<span class="sd">      self.running=False to stop)</span>

<span class="sd">    - `handle_get_handlers` (lists all available handler methods)</span>

<span class="sd">    - `handle_method_call` (call an arbitrary method on the server)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># just for testing - how long to allow it to wait on a queue.get</span>
    <span class="c1"># in real situations this should always be None</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_queue</span><span class="p">,</span> <span class="n">response_queue</span><span class="p">,</span> <span class="n">shared_attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the BaseServer.</span>

<span class="sd">        Subclasses should match this call signature exactly, even if they</span>
<span class="sd">        do not need shared_attrs, because it is used by `ServerManager`</span>
<span class="sd">        to instantiate the server.</span>
<span class="sd">        The base class does not start the event loop, subclasses should do</span>
<span class="sd">        this at the end of their own `__init__`.</span>

<span class="sd">        query_queue: a multiprocessing.Queue that we listen to</span>

<span class="sd">        response_queue: a multiprocessing.Queue where we put responses</span>

<span class="sd">        shared_attrs: (default None) any objects (such as other Queues)</span>
<span class="sd">            that we need to supply on initialization of the server because</span>
<span class="sd">            they cannot be picked normally to pass through the Queue later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span> <span class="o">=</span> <span class="n">query_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span> <span class="o">=</span> <span class="n">response_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shared_attrs</span> <span class="o">=</span> <span class="n">shared_attrs</span>

<div class="viewcode-block" id="BaseServer.run_event_loop"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.run_event_loop">[docs]</a>    <span class="k">def</span> <span class="nf">run_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default event loop. When this method returns, the server stops.</span>

<span class="sd">        Override this method if you need to do more than just process queries</span>
<span class="sd">        repeatedly, but make sure your event loop:</span>
<span class="sd">        - calls `self.process_query` to ensure robust error handling</span>
<span class="sd">        - provides a way to halt the server (and override `handle_halt` if</span>
<span class="sd">          it&#39;s not by setting `self.running = False`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseServer.process_query"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.process_query">[docs]</a>    <span class="k">def</span> <span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Act on one query received through the query queue.</span>

<span class="sd">        query: should have the form `(code, func_name[, args][, kwargs])`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">func_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_&#39;</span> <span class="o">+</span> <span class="n">func_name</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">part</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">part</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">QUERY_ASK</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_ask</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">(),</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">QUERY_WRITE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_write</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">(),</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseServer.report_error"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.report_error">[docs]</a>    <span class="k">def</span> <span class="nf">report_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common error handler for all queries.</span>

<span class="sd">        QUERY_ASK puts errors into the response queue for the asker to see.</span>
<span class="sd">        QUERY_WRITE shouldn&#39;t write a response, so it logs errors instead.</span>
<span class="sd">        Unknown modes do *both*, because we don&#39;t know where the user will be</span>
<span class="sd">        looking and an error that severe it&#39;s OK to muck up the queue.</span>
<span class="sd">        That&#39;s the only way you&#39;ll get a response without asking for one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Expected query to be a tuple (code, func_name[, args][, kwargs]) &#39;</span>
            <span class="s1">&#39;where code is QUERY_ASK or QUERY_WRITE, func_name points to a &#39;</span>
            <span class="s1">&#39;method `handle_&lt;func_name&gt;`, and optionally args is a tuple and &#39;</span>
            <span class="s1">&#39;kwargs is a dict</span><span class="se">\n</span><span class="s1">query: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">QUERY_ASK</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">QUERY_WRITE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">RESPONSE_ERROR</span><span class="p">,</span> <span class="n">error_str</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not put error on response queue</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                              <span class="n">error_str</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_process_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">RESPONSE_OK</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">(</span><span class="n">RESPONSE_ERROR</span><span class="p">,</span> <span class="nb">repr</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="n">format_exc</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_process_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">repr</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">format_exc</span><span class="p">())</span>

<div class="viewcode-block" id="BaseServer.handle_halt"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.handle_halt">[docs]</a>    <span class="k">def</span> <span class="nf">handle_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quit this server.</span>

<span class="sd">        Just sets self.running=False, which the default event loop looks for</span>
<span class="sd">        between queries. If you provide your own event loop and it does NOT</span>
<span class="sd">        look for self.running, you should override this handler with a</span>
<span class="sd">        different way to halt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="BaseServer.handle_get_handlers"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.handle_get_handlers">[docs]</a>    <span class="k">def</span> <span class="nf">handle_get_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all available query handlers.&quot;&quot;&quot;</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;handle_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)):</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;handle_&#39;</span><span class="p">):])</span>
        <span class="k">return</span> <span class="n">handlers</span></div>

<div class="viewcode-block" id="BaseServer.handle_method_call"><a class="viewcode-back" href="../../../auto/qcodes.process.html#qcodes.process.server.BaseServer.handle_method_call">[docs]</a>    <span class="k">def</span> <span class="nf">handle_method_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pass through arbitrary method calls to the server.</span>

<span class="sd">        Args:</span>
<span class="sd">            method_name (str): the method name to call.</span>
<span class="sd">                Primarily intended for NestedAttrAccess, ie:</span>
<span class="sd">                ``getattr``, ``setattr``, ``callattr``, ``delattr``.</span>

<span class="sd">            *args (Any): passed to the method</span>

<span class="sd">            **kwargs (Any): passed to the method</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: the return value of the method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>