
Offline Plotting Tutorial
=========================

The dataset comes with a tool for offline (i.e. not live as the data are
coming in) plotting. This notebook explains how to use it and what it is
capable of plotting. **NOTE**: This notebook only covers the plotting of
numerical data. For categorical (string-valued) data, please see
``Offline plotting with categorical data.ipynb``.

The tool in question is the function ``plot_by_id``.

.. code:: ipython3

    %matplotlib notebook
    import numpy as np
    
    import qcodes as qc
    
    from typing import List, Dict, Tuple, Any
    import matplotlib.pyplot as plt
    import qcodes as qc
    from qcodes import Parameter, new_experiment, Measurement
    from qcodes.dataset.plotting import plot_by_id
    from qcodes.dataset.database import initialise_database

First we make an experimental run, so that we have something to plot.

.. code:: ipython3

    initialise_database()
    new_experiment('test_plot_by_id', 'nosample')




.. parsed-literal::

    test_plot_by_id#nosample#2@./exp_container_tutorial.db
    ------------------------------------------------------



Next we make a handful of parameters to be used in the examples of this
notebook.

For those curious, setting ``set_cmd=None`` and ``get_cmd=None`` makes
the ``Parameters`` settable and gettable without them being hooked up to
any external/auxiliary action (in old QCoDeS versions, this was known as
a ``ManualParameter``).

.. code:: ipython3

    # Make a handful of parameters to be used in the examples
    
    x = Parameter(name='x', label='Voltage', unit='V',
                  set_cmd=None, get_cmd=None)
    t = Parameter(name='t', label='Time', unit='s',
                  set_cmd=None, get_cmd=None)
    y = Parameter(name='y', label='Voltage', unit='V',
                  set_cmd=None, get_cmd=None)
    y2 = Parameter(name='y2', label='Current', unit='A',
                   set_cmd=None, get_cmd=None)
    z = Parameter(name='z', label='Majorana number', unit='Anyonic charge',
                  set_cmd=None, get_cmd=None)

A single, simple 1D sweep
-------------------------

.. code:: ipython3

    meas = Measurement()
    meas.register_parameter(x)
    meas.register_parameter(y, setpoints=(x,))
    
    xvals = np.linspace(-3.4, 4.2, 250)
    
    # shuffle randomly the values in order to test that plot
    # that is to be created for this data is a correct line
    # that does not depend on the order of the data
    np.random.shuffle(xvals)
    
    with meas.run() as datasaver:
        for xnum in xvals:
            noise = np.random.randn()*0.1  # multiplicative noise yeah yeah
            datasaver.add_result((x, xnum),
                                 (y, 2*(xnum+noise)**3 - 5*(xnum+noise)**2))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 11


Now let us plot that run. The function ``plot_by_id`` takes the
``run_id`` of the run to plot as a positional argument. Furthermore, the
user may specify the matplotlib axis object (or list of axis objects) to
plot on.

If no axes are specified, the function creates new axis object(s). The
function returns a tuple of a list of the axes and a list of the
colorbar axes (just ``None``\ s if there are no colorbars).

.. code:: ipython3

    axes, cbaxes = plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='1f1d3627-e18f-4bc7-a58d-456243b2c53d'></div>


Using the returned axis, we can e.g. change the plot linewidth and
color. We refer to the matplotlib documentation for details on
matplotlib plot customization.

.. code:: ipython3

    my_ax = axes[0]
    line = my_ax.lines[0]
    line.set_color('#223344')
    line.set_linewidth(3)

Rescaling units and ticks
~~~~~~~~~~~~~~~~~~~~~~~~~

``plot_by_id`` can conveniently rescale the units and ticks of the plot.
For example, if one of the axes is voltage in units of ``V``, but the
values are in the range of millivolts, then ``plot_by_id`` will rescale
the ticks of the axis to show ``5`` instead of ``0.005``, and the unit
in the axis label will be adjusted from ``V`` to ``mV``.

This feature works with the relevant SI units, and some others. In case
the units of the parameter are not from that list, or are simply not
specified, ticks and labels are left intact.

The feature can be explicitly turned off by passing
``rescale_axes=False`` to ``plot_by_id``.

The following plot demontrates the feature.

.. code:: ipython3

    meas = Measurement()
    meas.register_parameter(t)
    meas.register_parameter(y, setpoints=(t,))
    
    with meas.run() as datasaver:
        for tnum in np.linspace(-3.4, 4.2, 50):
            noise = np.random.randn()*0.1
            datasaver.add_result((t, tnum*1e-6),
                                 (y, (2*(tnum+noise)**3 - 5*(tnum+noise)**2)*1e3))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 12


.. code:: ipython3

    plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='5c041516-0692-40d7-af97-0db0a2464797'></div>




.. parsed-literal::

    ([<matplotlib.axes._subplots.AxesSubplot at 0x7f7a66bf0898>], [None])



Two interleaved 1D sweeps
-------------------------

Now we make a run where two parameters are measured as a function of the
same parameter.

.. code:: ipython3

    meas = Measurement()
    meas.register_parameter(x)
    meas.register_parameter(y, setpoints=[x])
    meas.register_parameter(y2, setpoints=[x])
    
    xvals = np.linspace(-5, 5, 250)
    
    with meas.run() as datasaver:
    
        for xnum in xvals:
            datasaver.add_result((x, xnum),
                                 (y, xnum**2))
            datasaver.add_result((x, xnum),
                                 (y2, -xnum**2))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 13


In such a situation, ``plot_by_id`` by default creates a new axis for
**each** dependent parameter. Sometimes this is not desirable; we'd
rather have both plots on the same axis. In such a case, we might pass
the same axis twice to ``plot_by_id``.

.. code:: ipython3

    axes, cbaxes = plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='533a710c-e2ca-41d1-97a5-65f85b54857e'></div>



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='f6729d66-b60d-4cfc-ba39-1b8f6df169a7'></div>


Let's do that now

.. code:: ipython3

    fig, ax = plt.subplots(1)
    axes, cbaxes = plot_by_id(dataid, axes=[ax, ax])



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='35b01c77-0940-4ab4-8fc3-739a18a9262c'></div>


Regular 2D rectangular sweep scan
---------------------------------

For 2D plots, a colorbar is usually present. As mentioned above,
``plot_by_id`` returns this.

.. code:: ipython3

    meas = Measurement()
    
    meas.register_parameter(x)
    meas.register_parameter(t)
    meas.register_parameter(z, setpoints=(x, t))
    
    xvals = np.linspace(-4, 5, 50)
    tvals = np.linspace(-500, 1500, 25)
    
    with meas.run() as datasaver:
        for xv in xvals:
            for tv in tvals:
                # just some arbitrary semi good looking function
                zv = np.sin(2*np.pi*xv)*np.cos(2*np.pi*0.001*tv) + 0.001*tv
                datasaver.add_result((x, xv), (t, tv), (z, zv))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 14


.. code:: ipython3

    axes, colorbars = plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='9c53dc88-6bbc-4635-88d5-bb87814d70e8'></div>


A fairlt normal situation is that the colorbar was somehow mislabelled.
Using the returned colorbar, the label can be overwritten.

.. code:: ipython3

    colorbar = colorbars[0]
    colorbar.set_label('Correct science label')

Warped 2D rectangular sweep scan
--------------------------------

A nice feature of ``plot_by_id`` is that the grid may be warped; it
makes no difference. Here we warp the x axis of the previous scan to
increase the resolution in the right half plane.

.. code:: ipython3

    xvals = np.linspace(-4, 5, 50) + np.cos(-1/6*np.pi*xvals)
    tvals = np.linspace(-500, 1500, 25)
    
    with meas.run() as datasaver:
        for xv in xvals:
            for tv in tvals:
                zv = np.sin(2*np.pi*xv)*np.cos(2*np.pi*0.001*tv) + 0.001*tv
                datasaver.add_result((x, xv), (t, tv), (z, zv))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 15


.. code:: ipython3

    axes, cbaxes = plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='4f8ec508-4b14-40e3-b21a-b121bcf4b0aa'></div>


Interrupted 2D scans (a hole in the cheese)
-------------------------------------------

In case a sweep in interrupted, the entire grid will not be filled out.
This is also supported, in fact, any single rectangular hole is allowed

.. code:: ipython3

    xvals = np.linspace(-4, 5, 50) + np.cos(2/9*np.pi*xvals+np.pi/4)
    tvals = np.linspace(-500, 1500, 25)
    
    # define two small forbidden range functions
    def no_x(xv):
        if xv > 0 and xv < 3:
            return True
        else:
            return False
        
    def no_t(tv):
        if tv > 0 and tv < 450:
            return True
        else:
            return False
    
    with meas.run() as datasaver:
        for xv in xvals:
            for tv in tvals:
                if no_x(xv) and no_t(tv):
                    continue
                else:
                    zv = np.sin(2*np.pi*xv)*np.cos(2*np.pi*0.001*tv) + 0.001*tv
                    datasaver.add_result((x, xv), (t, tv), (z, zv))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 16


.. code:: ipython3

    axes, colorbars = plot_by_id(dataid)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='d6a13043-5cec-4162-b64a-10092e022496'></div>


Fancy plotting
--------------

As a final example, let us combine several plots in one window.

We first make a little grid of axes.

.. code:: ipython3

    fig, figaxes = plt.subplots(2, 2)



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='6a812ad5-d4e0-47f5-a4b7-58f0da496f8e'></div>


Next, we make some runs (shamelessly copy-pasting from above).

.. code:: ipython3

    # First run
    meas = Measurement()
    meas.register_parameter(x)
    meas.register_parameter(y, setpoints=(x,))
    
    xvals = np.linspace(-3.4, 4.2, 250)
    
    with meas.run() as datasaver:
        for xnum in xvals:
            noise = np.random.randn()*0.1  # multiplicative noise yeah yeah
            datasaver.add_result((x, xnum),
                                 (y, 2*(xnum+noise)**3 - 5*(xnum+noise)**2))
    
    rid1 = datasaver.run_id
    
    # Second run
    
    meas = Measurement()
    
    meas.register_parameter(x)
    meas.register_parameter(t)
    meas.register_parameter(z, setpoints=(x, t))
    
    xvals = np.linspace(-4, 5, 50)
    tvals = np.linspace(-500, 1500, 25)
    
    with meas.run() as datasaver:
        for xv in xvals:
            for tv in tvals:
                # just some arbitrary semi good looking function
                zv = np.sin(2*np.pi*xv)*np.cos(2*np.pi*0.001*tv) + 0.001*tv
                datasaver.add_result((x, xv), (t, tv), (z, zv))
    
    rid2 = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 17
    Starting experimental run with id: 18


And then we put them just where we please.

.. code:: ipython3

    axes, colorbars = plot_by_id(rid1, figaxes[0, 0])

.. code:: ipython3

    axes, colorbars = plot_by_id(rid2, figaxes[1, 1], colorbars)

Note that if we want to replot on an axis with a colorbar we probably
also want to reuse the colorbar

.. code:: ipython3

    axes, colorbars = plot_by_id(rid2, figaxes[1, 1], colorbars)

.. code:: ipython3

    fig.tight_layout()

Rasterizing
-----------

By default Matplotlib renders each individual data point as a separate
square in 2D plots when storing in a vector format (pdf,svg). This is
not a problem for small data sets, but the time needed to generate a pdf
increases rapidly with the number of data points. Therefore,
``plot_by_id`` will automatically rasterize the data (lines, ticks and
labels are still stored as text) if more than 5000 data points are
plotted. The particular value of the rasterization threshold can be set
in the ``qcodesrc.json`` config file.

Alternatively the rasterized keyword can be passed to the
``plot_by_id_function``

.. code:: ipython3

    meas = Measurement()
    
    meas.register_parameter(x)
    meas.register_parameter(t)
    meas.register_parameter(z, setpoints=(x, t))
    
    xvals = np.linspace(-4, 5, 100)
    tvals = np.linspace(-500, 1500, 500)
    
    with meas.run() as datasaver:
        for xv in xvals:
            for tv in tvals:
                # just some arbitrary semi good looking function
                zv = np.sin(2*np.pi*xv)*np.cos(2*np.pi*0.001*tv) + 0.001*tv
                datasaver.add_result((x, xv), (t, tv), (z, zv))
    
    dataid = datasaver.run_id


.. parsed-literal::

    Starting experimental run with id: 19


To get a feeling for the time difference between rasterzing and not, we
time the two approaches here.

.. code:: ipython3

    %%time
    axeslist, _ = plot_by_id(dataid)
    axeslist[0].figure.savefig(f'test_plot_by_id_{dataid}.pdf')



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='aeab3694-b88d-4a95-b179-928ffcaacbf5'></div>


.. parsed-literal::

    CPU times: user 1.11 s, sys: 109 ms, total: 1.22 s
    Wall time: 1.07 s


.. code:: ipython3

    %%time
    axeslist, _ = plot_by_id(dataid, rasterized=False)
    axeslist[0].figure.savefig(f'test_plot_by_id_{dataid}.pdf')



.. parsed-literal::

    <IPython.core.display.Javascript object>



.. raw:: html

    <div id='5bc094af-b991-48f0-b4ae-f6a6dce5fbbd'></div>


.. parsed-literal::

    CPU times: user 8.67 s, sys: 128 ms, total: 8.79 s
    Wall time: 8.69 s


